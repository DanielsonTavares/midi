<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        .container {
          display: flex;
        flex-wrap: wrap;
        }
        .listbox {
          width: 50%;
          height: 40px;
        }
        .elemento100 {
          width: 100%;
          height: 40px;
        }
        .label {
          width: 50%;
          
        }
        .botao {
          display: inline-block;
          width: 33.33%;
          height: 100px;
        }

        #modoEdicao{
          width: 20px;
          height: 20px;
        }

        .bottom {
                position:absolute;                 
                bottom:0;                         
                left:0;                         
            }

        .popup {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: none;
  }
  .popup-conteudo {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: white;
    padding: 20px;
    width: 50%;
    height: 20%;
  }
  .popup-barra {
    display: flex;
    justify-content: flex-end;
  }
  .popup-botao {
    margin-left: 10px;
  }

      </style>
      
      <script type="text/javascript" src="FileSaver.min.js"></script>
      <script>
        function btnClick(nmBotao){
          const modoEdicao = document.getElementById("modoEdicao");

          if (modoEdicao.checked) {
            mostrarPopUp(nmBotao);
          } else {
            console.log('clique normal');
          }
        }
        
        function mostrarPopUp(nmBotao){
          document.querySelector('.popup').style.display = 'block';
          document.getElementById('txtIdPad').value = nmBotao;
          
          document.getElementById('txtNomePad').value = pads[nmBotao].nome;
          document.getElementById('selCanalMidi').value = pads[nmBotao].canalMidi;
          document.getElementById('selCategoria').value = pads[nmBotao].categoria;

          let categoria = parseInt(getSelectedValue('selCategoria'));
          carregaTimbres(categoria);

          document.getElementById('selTimbre').value = pads[nmBotao].timbre;
          
        }

        function fecharPopUp(){
          document.querySelector('.popup').style.display = 'none';
          console.log('sair sem salvar');
        }

        function confirmarPopUp(){
          document.querySelector('.popup').style.display = 'none';
          const txtIdPad = parseInt(document.getElementById('txtIdPad').value);
          pads[txtIdPad].nome = document.getElementById('txtNomePad').value;
          pads[txtIdPad].canalMidi = parseInt(getSelectedValue('selCanalMidi'));
          pads[txtIdPad].categoria = parseInt(getSelectedValue('selCategoria'));
          pads[txtIdPad].timbre = parseInt(getSelectedValue('selTimbre'));

          carregaPads();
        }


        function getSelectedValue(elementId) {
          var elt = document.getElementById(elementId);

          if (elt.selectedIndex == -1)
              return null;

          return elt.options[elt.selectedIndex].value;
        }

      </script>
      
</head>
<body>
    <div class="container">
        <div class="label">Input</div>
        <div class="label">Output</div>
    </div>
    <div class="container">
      
        <select class="listbox">
          <!-- Opções para o primeiro listbox -->
        </select>
        
        <select class="listbox">
          <!-- Opções para o segundo listbox -->
        </select>
    </div>

    <div class="container" id="pnlEdicao">
      <label><input type="checkbox" id="modoEdicao" class="elemento100"> Modo edição</label>
    </div>

      <div class="container" id="painelPads">

      </div>

      <div class="container">
        <input type="file"  id="abrirArquivo" class="elemento100" onchange="abrir()">
      </div>

      <div class="container">
        <button id="salvar" class="elemento100" onClick="salvar()">Salvar</button>        
      </div>

      <div class="popup">
        <div class="popup-conteudo">

          <div class="popup-barra">
            <button id="confirmar-popup" class="popup-botao" onClick="confirmarPopUp()">Confirmar</button>
            <button id="fechar-popup" class="popup-botao" onClick="fecharPopUp()">Fechar</button>
          </div>

          <input type="hidden" id="txtIdPad">

          <div class="container">
            <div class="label">Nome:</div>
              <input type="text" id="txtNomePad">
          </div>

          <div class="container">
            <div class="label">Canal Midi:</div>
            <select class="" id="selCanalMidi">
              <option>1</option>
              <option>2</option>
              <option>3</option>
              <option>4</option>
              <option>5</option>
              <option>6</option>
              <option>7</option>
              <option>8</option>
              <option>9</option>
              <option>10</option>
              <option>11</option>
              <option>12</option>
              <option>13</option>
              <option>14</option>
              <option>15</option>
              <option>16</option>    
              
            </select>
          </div>

          <div class="container">
            <div class="label">Categoria:</div>
            <select class="" id="selCategoria"></select>
          </div>

          <div class="container">
            <div class="label">Timbre:</div>
            <select class="" id="selTimbre"></select>
          </div>
          


        </div>
      </div>

  <script>
    
    let pads = [
      {id:0, nome: "botao 1",   canalMidi: 2, categoria: 2, timbre: 4},
      {id:1, nome: "botao 2",   canalMidi: 1, categoria: 1, timbre: 3},
      {id:2, nome: "botao 3",   canalMidi: 1, categoria: 0, timbre: 0},
      {id:3, nome: "botao 4",   canalMidi: 1, categoria: 0, timbre: 0},
      {id:4, nome: "botao 5",   canalMidi: 1, categoria: 0, timbre: 0},
      {id:5, nome: "botao 6",   canalMidi: 1, categoria: 0, timbre: 0},
      {id:6, nome: "botao 7",   canalMidi: 1, categoria: 0, timbre: 0},
      {id:7, nome: "botao 8",   canalMidi: 1, categoria: 0, timbre: 0},
      {id:8, nome: "botao 9",   canalMidi: 1, categoria: 0, timbre: 0},
      {id:9, nome: "botao 10",  canalMidi: 1, categoria: 0, timbre: 0},
      {id:10, nome: "botao 11", canalMidi: 1, categoria: 0, timbre: 0},
      {id:11, nome: "botao 12", canalMidi: 1, categoria: 0, timbre: 0}
    ];

    const categorias = [
      {id: 0, nome: 'categoria 0'},
      {id: 1, nome: 'categoria 1'},
      {id: 2, nome: 'categoria 2'},
      {id: 3, nome: 'categoria 3'},
    ];

    const timbres = [
      {id: 0, idCategoria: 0, nome: 'guitarra'},
      {id: 1, idCategoria: 0, nome: 'violao'},
      {id: 2, idCategoria: 1, nome: 'piano'},
      {id: 3, idCategoria: 1, nome: 'orgao'},
      {id: 4, idCategoria: 2, nome: 'sax'},
      {id: 5, idCategoria: 2, nome: 'flauta'},
      {id: 6, idCategoria: 3, nome: 'bongo'},
      {id: 7, idCategoria: 3, nome: 'bateria'}
    ];

    function carregaPads(){
      console.log('iniciou carrega');
      const painelPads = document.getElementById('painelPads');
      painelPads.innerHTML = "";

      pads.forEach( (pad)=>{
        
        painelPads.innerHTML += `<button class='botao' onClick='btnClick(${pad.id})'>${pad.nome}</button>`;
      } )
    }

    function carregaCategorias(){
      const selCategoria = document.getElementById('selCategoria');
      selCategoria.innerHTML = "";

      categorias.forEach((c)=>{
        selCategoria.innerHTML += `<option value="${c.id}">${c.nome}</option>  `;
      });


      selCategoria.addEventListener('change', ()=>{
        console.log('recarrega os timbres');
        let categoria = parseInt(getSelectedValue('selCategoria'));
        carregaTimbres(categoria);
      })

    }

    function carregaTimbres(categoria) {
      const timbresSelecionados = timbres.filter((el)=>{
        return el.idCategoria == categoria;
      });

      const selTimbre = document.getElementById('selTimbre');
      selTimbre.innerHTML = "";

      timbresSelecionados.forEach((t)=>{
        selTimbre.innerHTML += `<option value="${t.id}">${t.nome}</option>  `;
      })
    }

    function salvar() {
      const save = {}

      const nomeArquivo = prompt('Informe um nome para o arquivo.', 'nomeArquivo');
      if(nomeArquivo == null) {
        return false;
      }

      save.pads = pads;
      save.input = {id: 0, nome: 'nome'};
      save.output = {id: 0, nome: 'nome'};
      save.name = '';

      let blob = new Blob([JSON.stringify(save)], { type: "text/plain;charset=utf-8" });
      saveAs(blob, nomeArquivo || 'nomeArquivo' + ".txt");

      return save;
    }

    let arquivoCarregado = []

    function abrir(){
      console.log('sdfadsfadsfs');
      const arquivo = document.getElementById('abrirArquivo').files[0];
      const reader = new FileReader();

      reader.addEventListener("load", () => {
    
      arquivoCarregado = JSON.parse(reader.result);
      pads = arquivoCarregado.pads;
      carregaPads(); 
    }, false);

     
     if (arquivo) {
       reader.readAsText(arquivo);
     }
      
     
    }

    carregaPads();
    carregaCategorias();

  </script>

</body>
</html>